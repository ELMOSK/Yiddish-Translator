<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Yiddish Translator | דער אולטימאַטיווער אידיש איבערזעצער</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Secular+One&family=David+Libre:wght@400;500;700&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gold: #FFD700;
            --deep-blue: #001f3f;
            --royal-purple: #4B0082;
            --warm-cream: #FFF8DC;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            background: #000;
        }
        
        /* Animated starfield background */
        #stars-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(to bottom, #000428 0%, #004e92 100%);
        }
        
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }
        
        /* Floating particles */
        .particle {
            position: fixed;
            pointer-events: none;
            opacity: 0.8;
            animation: float-up 15s linear infinite;
        }
        
        @keyframes float-up {
            0% { transform: translateY(100vh) translateX(0) rotate(0deg); opacity: 0; }
            10% { opacity: 0.8; }
            90% { opacity: 0.8; }
            100% { transform: translateY(-100vh) translateX(100px) rotate(360deg); opacity: 0; }
        }
        
        /* Main container */
        .main-container {
            position: relative;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            backdrop-filter: blur(5px);
        }
        
        /* Glass morphism card */
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            box-shadow: 
                0 8px 32px 0 rgba(31, 38, 135, 0.37),
                inset 0 0 30px rgba(255, 215, 0, 0.1);
            overflow: hidden;
            position: relative;
            max-width: 1200px;
            width: 100%;
            z-index: 1;
        }
        
        /* Glowing border animation */
        .glass-card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #FFD700, #4B0082, #00BFFF, #FFD700);
            border-radius: 30px;
            opacity: 0.7;
            z-index: -1;
            animation: glow 3s linear infinite;
            background-size: 400% 400%;
        }
        
        @keyframes glow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Hebrew/Yiddish text styling */
        .yiddish-text {
            font-family: 'David Libre', serif;
            direction: rtl;
            text-align: right;
        }
        
        .english-text {
            font-family: 'Inter', sans-serif;
            direction: ltr;
            text-align: left;
        }
        
        /* Title styling */
        .main-title {
            font-family: 'Secular One', sans-serif;
            background: linear-gradient(45deg, #FFD700, #FFA500, #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            animation: shimmer 3s ease-in-out infinite;
            font-size: clamp(2rem, 5vw, 3.5rem);
        }
        
        @keyframes shimmer {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        /* Textarea styling */
        .custom-textarea {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            transition: all 0.3s ease;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 215, 0, 0.5) transparent;
            position: relative;
            z-index: 10;
        }
        
        input.custom-textarea {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .custom-textarea::-webkit-scrollbar {
            width: 8px;
        }
        
        .custom-textarea::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .custom-textarea::-webkit-scrollbar-thumb {
            background: rgba(255, 215, 0, 0.5);
            border-radius: 4px;
        }
        
        .custom-textarea:focus {
            outline: none;
            border-color: var(--primary-gold);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
            background: rgba(255, 255, 255, 0.15);
        }
        
        /* Button styling */
        .magic-button {
            position: relative;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #000;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
            cursor: pointer;
            z-index: 10;
        }
        
        .magic-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s ease;
        }
        
        .magic-button:hover::before {
            left: 100%;
        }
        
        .magic-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.6);
        }
        
        /* Feature cards */
        .feature-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.2);
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        
        .feature-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .feature-card:hover::before {
            opacity: 1;
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
            border-color: rgba(255, 215, 0, 0.5);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.2);
        }
        
        /* Loading animation */
        .loader {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 215, 0, 0.3);
            border-top-color: var(--primary-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Pulse animation for new features */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse {
            animation: pulse 2s ease-in-out infinite;
        }
        
        /* Custom tooltip */
        .tooltip {
            position: relative;
        }
        
        .tooltip-text {
            visibility: hidden;
            background: rgba(0, 0, 0, 0.9);
            color: var(--primary-gold);
            text-align: center;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            white-space: nowrap;
            font-size: 14px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        /* Success animation */
        @keyframes success-pulse {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }
        
        .success-pulse {
            animation: success-pulse 0.5s ease-out;
        }
        
        /* Tab styling */
        .tab-button {
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab-button:hover {
            color: white;
            border-bottom-color: rgba(255, 215, 0, 0.5);
        }
        
        .tab-button.active {
            color: var(--primary-gold);
            border-bottom-color: var(--primary-gold);
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .glass-card {
                border-radius: 20px;
            }
            
            .main-title {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div id="stars-container"></div>
    
    <!-- Floating Particles -->
    <div id="particles-container"></div>
    
    <!-- Main App Container -->
    <div class="main-container">
        <div class="glass-card p-8 md:p-12">
            <!-- Header Section -->
            <header class="text-center mb-10">
                <h1 class="main-title mb-4">Ultimate Yiddish Translator</h1>
                <h2 class="text-2xl md:text-3xl font-bold text-yellow-400 yiddish-text text-center mb-2">דער אולטימאַטיווער אידיש איבערזעצער</h2>
                <p class="text-gray-300 text-lg">Experience the magic of translation with AI-powered precision</p>
                
                <!-- Quick Stats -->
                <div class="flex justify-center gap-8 mt-6">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-yellow-400" id="charCount">0</div>
                        <div class="text-sm text-gray-400">Characters</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-blue-400" id="wordCount">0</div>
                        <div class="text-sm text-gray-400">Words</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-green-400" id="translationCount">0</div>
                        <div class="text-sm text-gray-400">Translations</div>
                    </div>
                </div>
            </header>
            
            <!-- API Key Section -->
            <div id="apiKeySection" class="mb-8 p-6 feature-card rounded-xl">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold text-yellow-400">🔑 API Configuration</h3>
                    <span id="apiStatus" class="text-sm px-3 py-1 rounded-full bg-red-500 bg-opacity-20 text-red-400">Not Connected</span>
                </div>
                <div class="flex gap-3">
                    <input type="password" id="apiKeyInput"
                           class="flex-grow custom-textarea rounded-lg px-4 py-3 relative z-10"
                           placeholder="Enter your Gemini API Key (AIzaSy...)" />
                    <button id="submitApiKeyButton"
                            class="magic-button px-6 py-3 rounded-lg font-semibold relative z-10">
                        Connect
                    </button>
                </div>
                <p class="text-xs text-gray-400 mt-2">
                    Get your free API key from 
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" 
                       class="text-yellow-400 hover:text-yellow-300 underline relative z-10">Google AI Studio</a>
                </p>
            </div>
            
            <!-- Translation Modes -->
            <div class="mb-6">
                <div class="flex gap-4 mb-6 overflow-x-auto pb-2">
                    <button class="tab-button active px-4 py-2" data-mode="heimish">Heimish Style</button>
                    <button class="tab-button px-4 py-2" data-mode="formal">Formal</button>
                    <button class="tab-button px-4 py-2" data-mode="literary">Literary</button>
                    <button class="tab-button px-4 py-2" data-mode="modern">Modern</button>
                    <button class="tab-button px-4 py-2" data-mode="biblical">Biblical</button>
                </div>
            </div>
            
            <!-- Main Translation Area -->
            <div class="grid md:grid-cols-2 gap-6 mb-8">
                <!-- English Input -->
                <div>
                    <label class="block text-yellow-400 font-semibold mb-3 text-lg">
                        <span class="mr-2">📝</span> English Text
                    </label>
                    <textarea id="englishInput"
                              class="w-full custom-textarea rounded-xl p-4 english-text"
                              rows="10"
                              placeholder="Type or paste your English text here..."></textarea>
                    <div class="mt-3 flex justify-between items-center">
                        <button id="clearEnglish" class="text-gray-400 hover:text-yellow-400 transition">
                            Clear
                        </button>
                        <button id="pasteEnglish" class="text-gray-400 hover:text-yellow-400 transition">
                            Paste from clipboard
                        </button>
                    </div>
                </div>
                
                <!-- Yiddish Output -->
                <div>
                    <label class="block text-yellow-400 font-semibold mb-3 text-lg yiddish-text">
                        <span class="ml-2">📜</span> אידישע איבערזעצונג
                    </label>
                    <textarea id="yiddishOutput"
                              class="w-full custom-textarea rounded-xl p-4 yiddish-text"
                              rows="10"
                              readonly
                              placeholder="אייער איבערזעצונג וועט זיך דאָ באַווייזן..."></textarea>
                    <div class="mt-3 flex justify-between items-center">
                        <button id="copyYiddish" class="text-gray-400 hover:text-yellow-400 transition tooltip">
                            Copy
                            <span class="tooltip-text">Copy to clipboard</span>
                        </button>
                        <button id="shareYiddish" class="text-gray-400 hover:text-yellow-400 transition">
                            Share
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Translation Button -->
            <div class="text-center mb-8">
                <button id="translateButton"
                        class="magic-button px-12 py-4 rounded-xl text-lg font-bold">
                    <span id="translateText">Translate Now</span>
                    <div id="loadingIndicator" class="hidden">
                        <div class="loader mx-auto"></div>
                    </div>
                </button>
            </div>
            
            <!-- Advanced Features -->
            <div class="grid md:grid-cols-3 gap-6 mb-8">
                <!-- Voice Input -->
                <div class="feature-card p-6 rounded-xl text-center">
                    <div class="text-4xl mb-3">🎤</div>
                    <h4 class="text-yellow-400 font-semibold mb-2">Voice Input</h4>
                    <p class="text-gray-400 text-sm mb-4">Speak your text</p>
                    <button id="voiceInput" class="magic-button px-4 py-2 rounded-lg text-sm">
                        Start Recording
                    </button>
                </div>
                
                <!-- Text-to-Speech -->
                <div class="feature-card p-6 rounded-xl text-center">
                    <div class="text-4xl mb-3">🔊</div>
                    <h4 class="text-yellow-400 font-semibold mb-2">Listen</h4>
                    <p class="text-gray-400 text-sm mb-4">Hear the translation</p>
                    <button id="speakYiddish" class="magic-button px-4 py-2 rounded-lg text-sm">
                        Play Audio
                    </button>
                </div>
                
                <!-- History -->
                <div class="feature-card p-6 rounded-xl text-center">
                    <div class="text-4xl mb-3">📚</div>
                    <h4 class="text-yellow-400 font-semibold mb-2">History</h4>
                    <p class="text-gray-400 text-sm mb-4">Recent translations</p>
                    <button id="showHistory" class="magic-button px-4 py-2 rounded-lg text-sm">
                        View History
                    </button>
                </div>
            </div>
            
            <!-- Additional Tools -->
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Transliteration -->
                <div class="feature-card p-6 rounded-xl">
                    <h4 class="text-yellow-400 font-semibold mb-3 flex items-center">
                        <span class="mr-2">🔤</span> Transliteration
                    </h4>
                    <div id="transliteration" class="text-gray-300">
                        <p class="text-gray-500 italic">Translation will appear here in Latin characters</p>
                    </div>
                </div>
                
                <!-- Word Analysis -->
                <div class="feature-card p-6 rounded-xl">
                    <h4 class="text-yellow-400 font-semibold mb-3 flex items-center">
                        <span class="mr-2">📊</span> Word Analysis
                    </h4>
                    <div id="wordAnalysis" class="text-gray-300">
                        <p class="text-gray-500 italic">Select a word in the translation for details</p>
                    </div>
                </div>
            </div>
            
            <!-- Keyboard Shortcuts -->
            <div class="mt-8 text-center">
                <button id="toggleShortcuts" class="text-gray-400 hover:text-yellow-400 transition text-sm">
                    ⌨️ Keyboard Shortcuts
                </button>
                <div id="shortcutsList" class="hidden mt-4 p-4 bg-black bg-opacity-30 rounded-lg">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><kbd class="px-2 py-1 bg-gray-700 rounded">Ctrl+Enter</kbd> Translate</div>
                        <div><kbd class="px-2 py-1 bg-gray-700 rounded">Ctrl+C</kbd> Copy Translation</div>
                        <div><kbd class="px-2 py-1 bg-gray-700 rounded">Ctrl+L</kbd> Clear All</div>
                        <div><kbd class="px-2 py-1 bg-gray-700 rounded">Ctrl+H</kbd> Show History</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Notifications Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50"></div>
    
    <!-- History Modal -->
    <div id="historyModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="glass-card p-8 max-w-2xl w-full max-h-[80vh] overflow-y-auto m-4">
            <h3 class="text-2xl font-bold text-yellow-400 mb-6">Translation History</h3>
            <div id="historyList" class="space-y-4">
                <!-- History items will be added here -->
            </div>
            <button id="closeHistory" class="mt-6 magic-button px-6 py-2 rounded-lg">Close</button>
        </div>
    </div>

    <script>
        // Initialize stars background
        function createStars() {
            const starsContainer = document.getElementById('stars-container');
            const starCount = 150;
            
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.width = star.style.height = Math.random() * 3 + 'px';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                starsContainer.appendChild(star);
            }
        }
        
        // Initialize floating particles
        function createParticles() {
            const particlesContainer = document.getElementById('particles-container');
            const particles = ['✨', '🌟', '💫', '⭐', '✡️'];
            
            setInterval(() => {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.textContent = particles[Math.floor(Math.random() * particles.length)];
                particle.style.left = Math.random() * 100 + '%';
                particle.style.fontSize = Math.random() * 20 + 20 + 'px';
                particle.style.animationDuration = Math.random() * 10 + 10 + 's';
                particlesContainer.appendChild(particle);
                
                setTimeout(() => particle.remove(), 20000);
            }, 2000);
        }
        
        // Toast notification system
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full mb-2`;
            
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500',
                warning: 'bg-yellow-500'
            };
            
            toast.classList.add(colors[type] || colors.info);
            toast.textContent = message;
            
            const container = document.getElementById('toastContainer');
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            createStars();
            createParticles();
            
            // Get DOM elements
            const apiKeyInput = document.getElementById('apiKeyInput');
            const apiStatus = document.getElementById('apiStatus');
            const submitApiKeyButton = document.getElementById('submitApiKeyButton');
            const englishInput = document.getElementById('englishInput');
            const yiddishOutput = document.getElementById('yiddishOutput');
            const translateButton = document.getElementById('translateButton');
            const translateText = document.getElementById('translateText');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const charCount = document.getElementById('charCount');
            const wordCount = document.getElementById('wordCount');
            const translationCount = document.getElementById('translationCount');
            
            // Translation state
            let currentMode = 'heimish';
            let translationHistory = JSON.parse(localStorage.getItem('translationHistory') || '[]');
            let totalTranslations = parseInt(localStorage.getItem('totalTranslations') || '0');
            
            // Update counters
            translationCount.textContent = totalTranslations;
            
            // Load saved API key
            const savedApiKey = localStorage.getItem('geminiApiKey');
            if (savedApiKey) {
                apiKeyInput.value = savedApiKey;
                apiStatus.textContent = 'Connected';
                apiStatus.classList.remove('bg-red-500', 'text-red-400');
                apiStatus.classList.add('bg-green-500', 'text-green-400');
            }
            
            // Tab switching
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                    button.classList.add('active');
                    currentMode = button.dataset.mode;
                    showToast(`Switched to ${currentMode} translation mode`, 'info');
                });
            });
            
            // API key submission
            submitApiKeyButton.addEventListener('click', () => {
                const apiKey = apiKeyInput.value.trim();
                if (apiKey) {
                    localStorage.setItem('geminiApiKey', apiKey);
                    apiStatus.textContent = 'Connected';
                    apiStatus.classList.remove('bg-red-500', 'text-red-400');
                    apiStatus.classList.add('bg-green-500', 'text-green-400');
                    showToast('API key saved successfully!', 'success');
                } else {
                    showToast('Please enter a valid API key', 'error');
                }
            });
            
            // Text counters
            englishInput.addEventListener('input', () => {
                const text = englishInput.value;
                charCount.textContent = text.length;
                wordCount.textContent = text.trim() ? text.trim().split(/\s+/).length : 0;
            });
            
            // Translation function
            async function translate() {
                const englishText = englishInput.value.trim();
                const apiKey = apiKeyInput.value.trim();
                
                if (!apiKey) {
                    showToast('Please enter your API key first', 'error');
                    return;
                }
                
                if (!englishText) {
                    showToast('Please enter some text to translate', 'warning');
                    return;
                }
                
                // Show loading state
                translateText.classList.add('hidden');
                loadingIndicator.classList.remove('hidden');
                translateButton.disabled = true;
                
                try {
                    // Mode-specific prompts
                    const modePrompts = {
                        heimish: 'רעד א נארמאלע "חסידישע" אידיש, נישט בלויז איבערגעטייטשט נאר מיט באק ציינער... דו ביסט נישט בלויז אן איבערזעצער נאר דו געסט צו פארשטיין  דיינע ווערטער מיט טעם און געשמאק',
                        formal: 'שרייבסט טרוקןאין אידיש די אפטייטש ווי א פשוטע שפראך איבערזעצער',
                        literary: 'איבערטייטש  אלעס זייער ערענסט צו א נארמאלע אידיש',
                        modern: 'טייטש צו אידיש, אבער מער מאדערן, היינטיגע אידיש, קענסט אויך אריינוואפן ענגלישע ווערטער וואס זענען גרינג צו פארשטיין און עס איז נישט דא קיין געהעריגע אידישע ווארט דערפאר',
                        biblical: 'טייטש צו אידיש ווי א גאון מיט א געהויבענע שפראך רעד ווי אן עילוי פליסיג ווי קוואל'
                    };
                    
                    const prompt = `${modePrompts[currentMode]}. Do NOT add any words that are not present in the original English text. Provide only the Yiddish translation:\n\nEnglish: "${englishText}"\nYiddish:`;
                    
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ role: "user", parts: [{ text: prompt }] }]
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
                        const translatedText = result.candidates[0].content.parts[0].text.trim();
                        yiddishOutput.value = translatedText;
                        
                        // Save to history
                        const historyItem = {
                            english: englishText,
                            yiddish: translatedText,
                            mode: currentMode,
                            timestamp: new Date().toISOString()
                        };
                        
                        translationHistory.unshift(historyItem);
                        if (translationHistory.length > 50) {
                            translationHistory = translationHistory.slice(0, 50);
                        }
                        
                        localStorage.setItem('translationHistory', JSON.stringify(translationHistory));
                        
                        // Update translation count
                        totalTranslations++;
                        localStorage.setItem('totalTranslations', totalTranslations.toString());
                        translationCount.textContent = totalTranslations;
                        
                        // Animate success
                        translationCount.classList.add('pulse');
                        setTimeout(() => translationCount.classList.remove('pulse'), 1000);
                        
                        showToast('Translation complete!', 'success');
                        
                        // Generate transliteration
                        generateTransliteration(translatedText);
                    } else {
                        throw new Error('No translation received');
                    }
                    
                } catch (error) {
                    console.error('Translation error:', error);
                    showToast('Translation failed. Please check your API key and try again.', 'error');
                } finally {
                    translateText.classList.remove('hidden');
                    loadingIndicator.classList.add('hidden');
                    translateButton.disabled = false;
                }
            }
            
            // Transliteration function
            function generateTransliteration(yiddishText) {
                // Simple transliteration mapping (can be expanded)
                const transliterationMap = {
                    'א': 'a', 'אַ': 'a', 'אָ': 'o', 'ב': 'b', 'בֿ': 'v', 'ג': 'g',
                    'ד': 'd', 'ה': 'h', 'ו': 'u', 'וּ': 'u', 'ז': 'z', 'ח': 'kh',
                    'ט': 't', 'י': 'y', 'יִ': 'i', 'כּ': 'k', 'כ': 'kh', 'ך': 'kh',
                    'ל': 'l', 'מ': 'm', 'ם': 'm', 'נ': 'n', 'ן': 'n', 'ס': 's',
                    'ע': 'e', 'פּ': 'p', 'פֿ': 'f', 'ף': 'f', 'צ': 'ts', 'ץ': 'ts',
                    'ק': 'k', 'ר': 'r', 'ש': 'sh', 'שׂ': 's', 'ת': 't', 'תּ': 't'
                };
                
                let transliterated = '';
                for (let char of yiddishText) {
                    transliterated += transliterationMap[char] || char;
                }
                
                document.getElementById('transliteration').innerHTML = `
                    <p class="text-lg">${transliterated}</p>
                `;
            }
            
            // Translate button click
            translateButton.addEventListener('click', translate);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 'Enter':
                            e.preventDefault();
                            translate();
                            break;
                        case 'l':
                            e.preventDefault();
                            englishInput.value = '';
                            yiddishOutput.value = '';
                            showToast('Cleared all text', 'info');
                            break;
                        case 'h':
                            e.preventDefault();
                            document.getElementById('historyModal').style.display = 'flex';
                            break;
                    }
                }
            });
            
            // Clear button
            document.getElementById('clearEnglish').addEventListener('click', () => {
                englishInput.value = '';
                charCount.textContent = '0';
                wordCount.textContent = '0';
            });
            
            // Paste button
            document.getElementById('pasteEnglish').addEventListener('click', async () => {
                try {
                    const text = await navigator.clipboard.readText();
                    englishInput.value = text;
                    englishInput.dispatchEvent(new Event('input'));
                    showToast('Text pasted from clipboard', 'success');
                } catch (err) {
                    showToast('Failed to paste from clipboard', 'error');
                }
            });
            
            // Copy button
            document.getElementById('copyYiddish').addEventListener('click', () => {
                if (yiddishOutput.value) {
                    navigator.clipboard.writeText(yiddishOutput.value).then(() => {
                        showToast('קאָפּירט! (Copied!)', 'success');
                        
                        // Add visual feedback
                        const button = document.getElementById('copyYiddish');
                        button.classList.add('text-green-400');
                        setTimeout(() => button.classList.remove('text-green-400'), 1000);
                    });
                }
            });
            
            // Share button
            document.getElementById('shareYiddish').addEventListener('click', () => {
                if (yiddishOutput.value && navigator.share) {
                    navigator.share({
                        title: 'Yiddish Translation',
                        text: yiddishOutput.value
                    }).then(() => {
                        showToast('Shared successfully!', 'success');
                    }).catch(err => {
                        console.log('Share cancelled');
                    });
                } else if (!yiddishOutput.value) {
                    showToast('No translation to share', 'warning');
                } else {
                    // Fallback - copy to clipboard
                    navigator.clipboard.writeText(yiddishOutput.value).then(() => {
                        showToast('Copied to clipboard for sharing', 'success');
                    });
                }
            });
            
            // Voice input with proper stop functionality
            let recognition = null;
            let isRecording = false;
            
            document.getElementById('voiceInput').addEventListener('click', () => {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    
                    if (!isRecording) {
                        // Start recording
                        recognition = new SpeechRecognition();
                        recognition.lang = 'en-US';
                        recognition.continuous = true;
                        recognition.interimResults = true;
                        
                        recognition.onstart = () => {
                            isRecording = true;
                            document.getElementById('voiceInput').textContent = 'Stop Recording';
                            document.getElementById('voiceInput').classList.add('pulse');
                            document.getElementById('voiceInput').style.background = 'linear-gradient(45deg, #FF6B6B, #FF4444)';
                            showToast('Listening... Speak now', 'info');
                        };
                        
                        recognition.onresult = (event) => {
                            let finalTranscript = '';
                            let interimTranscript = '';
                            
                            for (let i = event.resultIndex; i < event.results.length; i++) {
                                const transcript = event.results[i][0].transcript;
                                if (event.results[i].isFinal) {
                                    finalTranscript += transcript + ' ';
                                } else {
                                    interimTranscript += transcript;
                                }
                            }
                            
                            if (finalTranscript) {
                                englishInput.value = (englishInput.value + ' ' + finalTranscript).trim();
                                englishInput.dispatchEvent(new Event('input'));
                            }
                        };
                        
                        recognition.onerror = (event) => {
                            showToast('Voice input error: ' + event.error, 'error');
                            isRecording = false;
                            document.getElementById('voiceInput').textContent = 'Start Recording';
                            document.getElementById('voiceInput').classList.remove('pulse');
                            document.getElementById('voiceInput').style.background = '';
                        };
                        
                        recognition.onend = () => {
                            isRecording = false;
                            document.getElementById('voiceInput').textContent = 'Start Recording';
                            document.getElementById('voiceInput').classList.remove('pulse');
                            document.getElementById('voiceInput').style.background = '';
                            if (englishInput.value.trim()) {
                                showToast('Voice input completed', 'success');
                            }
                        };
                        
                        try {
                            recognition.start();
                        } catch (error) {
                            showToast('Failed to start recording', 'error');
                            isRecording = false;
                        }
                    } else {
                        // Stop recording
                        if (recognition) {
                            recognition.stop();
                            isRecording = false;
                            showToast('Recording stopped', 'info');
                        }
                    }
                } else {
                    showToast('Voice input not supported in your browser', 'warning');
                }
            });
            
            // Text-to-speech with stop functionality
            let currentUtterance = null;
            let isSpeaking = false;
            
            document.getElementById('speakYiddish').addEventListener('click', () => {
                if (yiddishOutput.value && 'speechSynthesis' in window) {
                    if (!isSpeaking) {
                        // Start speaking
                        // Cancel any ongoing speech
                        speechSynthesis.cancel();
                        
                        currentUtterance = new SpeechSynthesisUtterance(yiddishOutput.value);
                        currentUtterance.lang = 'he'; // Hebrew is closest available
                        currentUtterance.rate = 0.9;
                        
                        currentUtterance.onstart = () => {
                            isSpeaking = true;
                            document.getElementById('speakYiddish').textContent = 'Stop Audio';
                            document.getElementById('speakYiddish').classList.add('pulse');
                            document.getElementById('speakYiddish').style.background = 'linear-gradient(45deg, #FF6B6B, #FF4444)';
                        };
                        
                        currentUtterance.onend = () => {
                            isSpeaking = false;
                            document.getElementById('speakYiddish').textContent = 'Play Audio';
                            document.getElementById('speakYiddish').classList.remove('pulse');
                            document.getElementById('speakYiddish').style.background = '';
                        };
                        
                        currentUtterance.onerror = () => {
                            isSpeaking = false;
                            document.getElementById('speakYiddish').textContent = 'Play Audio';
                            document.getElementById('speakYiddish').classList.remove('pulse');
                            document.getElementById('speakYiddish').style.background = '';
                            showToast('Speech synthesis error', 'error');
                        };
                        
                        speechSynthesis.speak(currentUtterance);
                    } else {
                        // Stop speaking
                        speechSynthesis.cancel();
                        isSpeaking = false;
                        document.getElementById('speakYiddish').textContent = 'Play Audio';
                        document.getElementById('speakYiddish').classList.remove('pulse');
                        document.getElementById('speakYiddish').style.background = '';
                        showToast('Audio stopped', 'info');
                    }
                } else if (!yiddishOutput.value) {
                    showToast('No translation to speak', 'warning');
                } else {
                    showToast('Text-to-speech not supported', 'warning');
                }
            });
            
            // History modal
            document.getElementById('showHistory').addEventListener('click', () => {
                const modal = document.getElementById('historyModal');
                const historyList = document.getElementById('historyList');
                
                historyList.innerHTML = '';
                
                if (translationHistory.length === 0) {
                    historyList.innerHTML = '<p class="text-gray-400 text-center">No translations yet</p>';
                } else {
                    translationHistory.forEach((item, index) => {
                        const historyItem = document.createElement('div');
                        historyItem.className = 'feature-card p-4 rounded-lg';
                        historyItem.innerHTML = `
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-yellow-400 text-sm">${new Date(item.timestamp).toLocaleString()}</span>
                                <span class="text-blue-400 text-sm">${item.mode}</span>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-gray-400 text-xs mb-1">English:</p>
                                    <p class="text-gray-200 text-sm">${item.english}</p>
                                </div>
                                <div>
                                    <p class="text-gray-400 text-xs mb-1 yiddish-text">אידיש:</p>
                                    <p class="text-gray-200 text-sm yiddish-text">${item.yiddish}</p>
                                </div>
                            </div>
                            <button class="mt-2 text-yellow-400 hover:text-yellow-300 text-sm" onclick="loadFromHistory(${index})">
                                Load this translation
                            </button>
                        `;
                        historyList.appendChild(historyItem);
                    });
                }
                
                modal.style.display = 'flex';
            });
            
            // Close history modal
            document.getElementById('closeHistory').addEventListener('click', () => {
                document.getElementById('historyModal').style.display = 'none';
            });
            
            // Click outside to close modal
            document.getElementById('historyModal').addEventListener('click', (e) => {
                if (e.target.id === 'historyModal') {
                    document.getElementById('historyModal').style.display = 'none';
                }
            });
            
            // Load from history function
            window.loadFromHistory = (index) => {
                const item = translationHistory[index];
                if (item) {
                    englishInput.value = item.english;
                    yiddishOutput.value = item.yiddish;
                    englishInput.dispatchEvent(new Event('input'));
                    
                    // Set the mode
                    document.querySelectorAll('.tab-button').forEach(button => {
                        button.classList.remove('active');
                        if (button.dataset.mode === item.mode) {
                            button.classList.add('active');
                            currentMode = item.mode;
                        }
                    });
                    
                    document.getElementById('historyModal').style.display = 'none';
                    showToast('Translation loaded from history', 'success');
                }
            };
            
            // Toggle shortcuts
            document.getElementById('toggleShortcuts').addEventListener('click', () => {
                const shortcutsList = document.getElementById('shortcutsList');
                shortcutsList.classList.toggle('hidden');
            });
            
            // Word selection for analysis
            yiddishOutput.addEventListener('mouseup', () => {
                const selection = window.getSelection().toString().trim();
                if (selection && selection.length > 0) {
                    // Simple word analysis
                    const wordAnalysis = document.getElementById('wordAnalysis');
                    wordAnalysis.innerHTML = `
                        <p class="text-yellow-400 mb-2">Selected: <span class="yiddish-text">${selection}</span></p>
                        <p class="text-gray-300 text-sm">Length: ${selection.length} characters</p>
                        <p class="text-gray-300 text-sm">Click to search in dictionary (coming soon)</p>
                    `;
                }
            });
            
            // Initial animation
            setTimeout(() => {
                document.querySelector('.glass-card').style.opacity = '1';
            }, 100);
        });
    </script>
</body>
</html>